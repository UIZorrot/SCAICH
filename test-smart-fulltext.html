<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Fulltext Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #52c41a;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        button:hover { background: #389e0d; }
        button:disabled { 
            background: #d9d9d9; 
            cursor: not-allowed; 
            color: #999;
        }
        .result-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            min-height: 100px;
        }
        .success { 
            background: #d4edda; 
            border-color: #c3e6cb; 
            color: #155724; 
        }
        .error { 
            background: #f8d7da; 
            border-color: #f5c6cb; 
            color: #721c24; 
        }
        .info { 
            background: #d1ecf1; 
            border-color: #bee5eb; 
            color: #0c5460; 
        }
        .doi-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Smart Fulltext Button Test</h1>
    <p>This tests the new intelligent fulltext logic: try proxy first, fallback to DOI if proxy fails.</p>

    <div class="test-section">
        <h3>Test Case 1: Valid DOI</h3>
        <div class="doi-info">
            <strong>DOI:</strong> 10.1136/heartjnl-2017-311198<br>
            <strong>Expected:</strong> Try proxy ‚Üí If fails, open DOI page
        </div>
        <button onclick="testSmartFulltext('10.1136/heartjnl-2017-311198', 1)">
            üî¨ View Fulltext (Smart)
        </button>
        <div id="result1" class="result-display">
            Click the button to test smart fulltext logic...
        </div>
    </div>

    <div class="test-section">
        <h3>Test Case 2: Another Valid DOI</h3>
        <div class="doi-info">
            <strong>DOI:</strong> 10.1038/nature12373<br>
            <strong>Expected:</strong> Try proxy ‚Üí If fails, open DOI page
        </div>
        <button onclick="testSmartFulltext('10.1038/nature12373', 2)">
            üî¨ View Fulltext (Smart)
        </button>
        <div id="result2" class="result-display">
            Click the button to test smart fulltext logic...
        </div>
    </div>

    <div class="test-section">
        <h3>Test Case 3: Invalid DOI (Should fail gracefully)</h3>
        <div class="doi-info">
            <strong>DOI:</strong> 10.invalid/test123<br>
            <strong>Expected:</strong> Proxy fails ‚Üí Open DOI page (which may also fail)
        </div>
        <button onclick="testSmartFulltext('10.invalid/test123', 3)">
            üî¨ View Fulltext (Smart)
        </button>
        <div id="result3" class="result-display">
            Click the button to test smart fulltext logic...
        </div>
    </div>

    <div class="test-section">
        <h3>Manual URL Tests</h3>
        <p>Test the URLs directly:</p>
        <button onclick="testProxyDirect('10.1136/heartjnl-2017-311198')">
            üîó Test Proxy URL Directly
        </button>
        <button onclick="testDoiDirect('10.1136/heartjnl-2017-311198')">
            üìÑ Test DOI URL Directly
        </button>
        <div id="manualResult" class="result-display">
            Manual test results will appear here...
        </div>
    </div>

    <script>
        // Ê®°Êãü SearchResult ÁªÑ‰ª∂ÁöÑÊô∫ËÉΩÈÄªËæë
        async function checkProxyAvailability(proxyUrl) {
            try {
                console.log(`Checking proxy availability: ${proxyUrl}`);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const response = await fetch(proxyUrl, {
                    method: 'HEAD',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const contentType = response.headers.get('content-type');
                const isSuccess = response.ok && (
                    contentType?.includes('application/pdf') || 
                    contentType?.includes('application/octet-stream') ||
                    response.status === 200
                );
                
                console.log(`Proxy check result: ${response.status}, Content-Type: ${contentType}, Available: ${isSuccess}`);
                return isSuccess;
                
            } catch (error) {
                console.log('Proxy availability check failed:', error.message);
                return false;
            }
        }

        async function testSmartFulltext(doi, testNumber) {
            const resultDiv = document.getElementById(`result${testNumber}`);
            const button = event.target;
            
            button.disabled = true;
            resultDiv.className = 'result-display info';
            resultDiv.innerHTML = '<div class="loading">üîÑ Testing smart fulltext logic...</div>';
            
            try {
                const cleanDoi = doi.replace(/^https?:\/\/doi\.org\//i, "");
                const encodedDoi = encodeURIComponent(cleanDoi);
                
                const proxyUrl = `https://api.scai.sh/api/fulltext/proxy/${encodedDoi}`;
                const doiUrl = `https://doi.org/${cleanDoi}`;
                
                resultDiv.innerHTML += `<br><strong>Step 1:</strong> Checking proxy availability...<br>`;
                resultDiv.innerHTML += `<small>Proxy URL: ${proxyUrl}</small><br>`;
                
                const isProxyAvailable = await checkProxyAvailability(proxyUrl);
                
                if (isProxyAvailable) {
                    resultDiv.className = 'result-display success';
                    resultDiv.innerHTML += `<br><strong>‚úÖ Proxy is available!</strong><br>`;
                    resultDiv.innerHTML += `<strong>Action:</strong> Opening proxy URL in new tab...<br>`;
                    window.open(proxyUrl, '_blank');
                } else {
                    resultDiv.className = 'result-display error';
                    resultDiv.innerHTML += `<br><strong>‚ùå Proxy not available</strong><br>`;
                    resultDiv.innerHTML += `<strong>Fallback:</strong> Opening DOI page instead...<br>`;
                    resultDiv.innerHTML += `<small>DOI URL: ${doiUrl}</small><br>`;
                    window.open(doiUrl, '_blank');
                }
                
            } catch (error) {
                resultDiv.className = 'result-display error';
                resultDiv.innerHTML += `<br><strong>‚ùå Error:</strong> ${error.message}`;
            } finally {
                button.disabled = false;
            }
        }

        function testProxyDirect(doi) {
            const cleanDoi = doi.replace(/^https?:\/\/doi\.org\//i, "");
            const encodedDoi = encodeURIComponent(cleanDoi);
            const proxyUrl = `https://api.scai.sh/api/fulltext/proxy/${encodedDoi}`;
            
            document.getElementById('manualResult').innerHTML = `
                <strong>üîó Opening Proxy URL:</strong><br>
                <small>${proxyUrl}</small>
            `;
            
            window.open(proxyUrl, '_blank');
        }

        function testDoiDirect(doi) {
            const cleanDoi = doi.replace(/^https?:\/\/doi\.org\//i, "");
            const doiUrl = `https://doi.org/${cleanDoi}`;
            
            document.getElementById('manualResult').innerHTML = `
                <strong>üìÑ Opening DOI URL:</strong><br>
                <small>${doiUrl}</small>
            `;
            
            window.open(doiUrl, '_blank');
        }
    </script>
</body>
</html>
